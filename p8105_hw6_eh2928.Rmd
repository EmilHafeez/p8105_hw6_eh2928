---
title: "Homework 6, Linear Models"
author: "Emil Hafeez (eh2928)"
date: "11/23/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Load relevant libraries
library(tidyverse)
library(p8105.datasets)
library(modelr)
#Prep for neater output
knitr::opts_chunk$set(
 fig.width = 6,
 fig.asp = 0.8,
 out.width = "80%"
)
#Theming with viridis, minimal
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
#set seed for replicability
set.seed(1)
```

# Problem One

Read in and tidy
```{r read in and tidy, message = F}
homicide_df = 
  read_csv("data/homicide.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)
  ) %>% 
  filter(
    victim_race %in% c("White", "Black"),
    !city_state %in% c("Tulsa, AL", "Dallas, TX", "Phoenix, AZ", "Kansas City, MO")) %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```

Start with a regression for just one city.

```{r}
baltimore_df =
  homicide_df %>% 
  filter(city_state == "Baltimore, MD")

glm(resolution ~ victim_age + victim_race + victim_sex, 
    data = baltimore_df,
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(col.names =
                c("Variable", "Odds Ratio Estimate", "Lower CI", "Upper CI"),
              align = "cccc", 
              digits = 3
              )
```

Now, let's run this across multiple cities (all of the 47 remaining).

```{r}
models_results_df = 
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)
  ) %>% 
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, term, OR, starts_with("CI")) 
```

Plot the resultant ORs and CIs of the logistic regression.

```{r}
models_results_df %>% 
  filter(term == "victim_raceWhite") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  geom_hline(yintercept = 1, color = "red") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1)) +
  scale_y_continuous(breaks = seq(0, 30, 5)) +
  labs(
    title = "Fig. 1: Estimates of the OR for Solving Homicides in US Cities",
    x = "City",
    y = "Odds Ratio Estimate, with CI Bars",
    caption = "Homework 6: Odds Ratio for Solving Homicides where Victim is White (vs reference: Black), Holding Age and Binary Gender Constant")
```

The results show that in many US cities of the 47 for which data are available, the odds of a homicide case ending in arrest are greater when the victim is white compared to Black, holding age of the victim and gender (binary) constant. While there is variability in these estimated which often overlaps the null hypothesis value of OR = 1, most estimates are above 1, and many cities have CIs above 1 which do not overlap the null. This is another modern example of racial injustice in our judicial system, for even if arrest and incarceration is not an effective solution, the apparent racial disparity of whose victims find "justice" as defined by our criminal system feels like yet another example of who is prioritized in our society. 

# Problem Two

Load and tidy the data for model fitting.
```{r, results = "hide", message = F}
birthweight_df = 
  read_csv("data/birthweight.csv") %>% 
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    mrace = as.factor(mrace)
  ) %>% # seeing as these factor labels stay in the same order as the data dictionary, regression interpretation will fall along the same lines, and so I leave this as-is rather than add labels and manually order in terms of fct_infreq() or something similar
  ungroup() %>% 
  select(bwt, babysex, bhead, blength, gaweeks, malform, ppbmi, ppwt, delwt, wtgain, mheight, momage, mrace, menarche, frace, fincome, parity, pnumlbw, pnumsga, smoken) %>% 
  select(-pnumlbw, -pnumsga)

summary(birthweight_df)
```



Fit a regression model and plot the model residuals against fitted values, using the original data frame.
```{r}
fit = lm(bwt ~ bhead + blength + blength*bhead + babysex + smoken + fincome + momage, data = birthweight_df)
summary(fit)
AIC(fit)
```

Plot the model residuals vs fitted values
```{r plot cache = TRUE}
birthweight_df %>% 
  add_residuals(fit) %>% 
  add_predictions(fit) %>% 
  ggplot(aes(x = pred, y = resid, alpha = 0.1, color = "blue")) + 
  geom_point()

# add a boxplot??
```

















Let's get model comparison working with the two given models

```{r cache = TRUE}
cv_df = 
  crossv_mc(birthweight_df, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

#test if it's working
#cv_df %>% pull(train) %>% .[[1]] %>% as_tibble
```

Can we create three functions mapped over each of the cross-validation resample objects? Also store the RMSE. 
```{r cache = TRUE}
cv_df = 
  cv_df %>% 
  mutate(
    simple_model  = map(train, ~lm(bwt ~ bhead + gaweeks, data = .x)),
    complex_model  = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + blength*babysex +  bhead*blength*babysex, data = .x))) %>% 
  mutate(
    rmse_simple = map2_dbl(simple_model, test, ~rmse(model = .x, data = .y)),
    rmse_complex = map2_dbl(complex_model, test, ~rmse(model = .x, data = .y)))
```

Let's also plot the RMSEs for each model to compare them
```{r cache = TRUE}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin()
```






Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model residuals against fitted values â€“ use add_predictions and add_residuals in making this plot.















# Problem Three
```{r}

```


